

<div [formGroup]="shipmentForm" class="modal-container">
  <div class="modal-header">
    <h1 mat-dialog-title class="modal-title">Shipment Information</h1>
    <button mat-icon-button (click)="closeDialog()" class="close-button" aria-label="Close dialog">
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <div *ngIf="isLoading" class="flex justify-center items-center h-96">
    <mat-spinner></mat-spinner>
  </div>

  <div *ngIf="!isLoading" class="modal-content bg-gray-50 py-2 px-3">
    <div class="max-w-full mx-auto">
      <div class="grid grid-cols-1 lg:grid-cols-12 gap-3 lg:h-[calc(100vh-180px)]">
        <!-- Main Form Section - Order 1 on mobile, Order 1 on desktop -->
        <div class="lg:col-span-7 overflow-y-auto order-1 lg:max-h-full">
          <div class="bg-white rounded-lg shadow-sm p-3">

          <!-- Document Uploads -->
          <div class="mb-3">
            <h2 class="text-sm font-semibold text-gray-900 mb-3">Document Uploads</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  IDF Document <span class="text-red-500">*</span>
                </label>
                <div class="border-2 border-dashed border-gray-300 rounded-md p-3 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" (click)="idfDocument.click()">
                  <button type="button" mat-button color="primary">
                    Choose file
                  </button>
                  <input hidden #idfDocument type="file" (change)="onFileSelected($event, 'idfDocument')">
                  <p class="text-xs text-gray-500 mt-1">{{ shipmentForm.get('idfDocument').value?.name || 'No file chosen' }}</p>
                </div>
                <p *ngIf="duplicateFileErrors['idfDocument']" class="text-xs text-red-600 mt-1">{{ duplicateFileErrors['idfDocument'] }}</p>
              </div>
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-1">
                  Invoice <span class="text-red-500">*</span>
                </label>
                <div class="border-2 border-dashed border-gray-300 rounded-md p-3 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" (click)="invoice.click()">
                  <button type="button" mat-button color="primary">
                    Choose file
                  </button>
                  <input hidden #invoice type="file" (change)="onFileSelected($event, 'invoice')">
                  <p class="text-xs text-gray-500 mt-1">{{ shipmentForm.get('invoice').value?.name || 'No file chosen' }}</p>
                </div>
                <p *ngIf="duplicateFileErrors['invoice']" class="text-xs text-red-600 mt-1">{{ duplicateFileErrors['invoice'] }}</p>
              </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-2 mb-2">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      KRA PIN Certificate <span class="text-red-500">*</span>
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-md p-3 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" (click)="kraPinCertificate.click()">
                      <button type="button" mat-button color="primary">
                        Choose file
                      </button>
                      <input hidden #kraPinCertificate type="file" (change)="onFileSelected($event, 'kraPinCertificate')">
                      <p class="text-xs text-gray-500 mt-1">{{ shipmentForm.get('kraPinCertificate').value?.name || 'No file chosen' }}</p>
                    </div>
                    <p *ngIf="duplicateFileErrors['kraPinCertificate']" class="text-xs text-red-600 mt-1">{{ duplicateFileErrors['kraPinCertificate'] }}</p>
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                      National ID <span class="text-red-500">*</span>
                    </label>
                    <div class="border-2 border-dashed border-gray-300 rounded-md p-3 text-center cursor-pointer hover:border-blue-400 hover:bg-blue-50 transition-colors" (click)="nationalId.click()">
                      <button type="button" mat-button color="primary">
                        Choose file
                      </button>
                      <input hidden #nationalId type="file" (change)="onFileSelected($event, 'nationalId')">
                      <p class="text-xs text-gray-500 mt-1">{{ shipmentForm.get('nationalId').value?.name || 'No file chosen' }}</p>
                    </div>
                    <p *ngIf="duplicateFileErrors['nationalId']" class="text-xs text-red-600 mt-1">{{ duplicateFileErrors['nationalId'] }}</p>
                  </div>
            </div>
            <div class="flex items-center">
                <mat-checkbox formControlName="agreeToTerms" color="primary"></mat-checkbox>
                <label class="text-sm text-gray-600 ml-2">
                  I agree to the <a (click)="openTermsOfUse($event)" class="text-blue-600 hover:underline cursor-pointer">Terms of Use</a> and to the <a (click)="openPrivacyPolicy($event)" class="text-blue-600 hover:underline cursor-pointer">Data Privacy Policy</a>
                </label>
            </div>
          </div>

          <!-- Personal Details & KYC -->
          <div class="mb-3 mt-2" [class.disabled-section]="!shipmentForm.get('agreeToTerms')?.value">
            <h2 class="text-sm font-semibold text-gray-900 mb-3">Importer Details</h2>
            <div *ngIf="!shipmentForm.get('agreeToTerms')?.value" class="disabled-overlay">
              <mat-icon>lock</mat-icon>
              <p>Please agree to the Terms of Use and Data Privacy Policy to enable this section</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                <mat-form-field appearance="outline">
                    <mat-label>ID Number
                        <mat-icon class="format-info-icon" 
                                  matTooltip="Required format: Exactly 8 digits&#10;Example: 12345678" 
                                  matTooltipClass="format-tooltip"
                                  matTooltipPosition="above">
                            info
                        </mat-icon>
                    </mat-label>
                    <input matInput formControlName="idNumber" placeholder="12345678" maxlength="8" (input)="onIdNumberInput($event)">
                    <mat-error *ngIf="shipmentForm.get('idNumber')?.hasError('required')">
                        ID Number is required
                    </mat-error>
                    <mat-error *ngIf="shipmentForm.get('idNumber')?.hasError('idNumber')">
                        Invalid format. Must be exactly 8 digits.
                    </mat-error>
                </mat-form-field>
                <mat-form-field appearance="outline">
                    <mat-label>KRA PIN
                        <mat-icon class="format-info-icon" 
                                  matTooltip="Required format: 1 capital letter + 9 digits + 1 capital letter&#10;Example: Z123456789X" 
                                  matTooltipClass="format-tooltip"
                                  matTooltipPosition="above">
                            info
                        </mat-icon>
                    </mat-label>
                    <input matInput formControlName="kraPin" placeholder="Z123456789X" maxlength="11" style="text-transform: uppercase;" (input)="onKraPinInput($event)">
                    <mat-error *ngIf="shipmentForm.get('kraPin')?.hasError('required')">
                        KRA PIN is required
                    </mat-error>
                    <mat-error *ngIf="shipmentForm.get('kraPin')?.hasError('kraPin')">
                        Invalid format. Must be: Letter + 9 digits + Letter
                    </mat-error>
                </mat-form-field>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
              <mat-form-field appearance="outline">
                <mat-label>First Name</mat-label>
                <input matInput formControlName="firstName" placeholder="Enter first name">
              </mat-form-field>
              <mat-form-field appearance="outline">
                <mat-label>Last Name</mat-label>
                <input matInput formControlName="lastName" placeholder="Enter last name">
              </mat-form-field>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                <mat-form-field appearance="outline">
                    <mat-label>Email Address</mat-label>
                    <input matInput formControlName="emailAddress" placeholder="Enter email address">
                </mat-form-field>
                <mat-form-field appearance="outline">
                    <mat-label>Phone Number</mat-label>
                    <input matInput formControlName="phoneNumber" placeholder="Enter phone number">
                </mat-form-field>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-4">
                <mat-form-field appearance="outline">
                    <mat-label>Postal Address</mat-label>
                    <input matInput formControlName="streetAddress" placeholder="Enter your postal address">
                </mat-form-field>
                <mat-form-field appearance="outline">
                    <mat-label>Postal Code</mat-label>
                    <input matInput formControlName="postalCode" placeholder="Enter postal code (numbers only)">
                </mat-form-field>
            </div>
          </div>

          <!-- Shipment Details -->
          <div class="mb-3 mt-2" [class.disabled-section]="!shipmentForm.get('agreeToTerms')?.value">
            <h2 class="text-sm font-semibold text-gray-900 mb-3">Shipment Details</h2>
            <div *ngIf="!shipmentForm.get('agreeToTerms')?.value" class="disabled-overlay">
              <mat-icon>lock</mat-icon>
              <p>Please agree to the Terms of Use and Data Privacy Policy to enable this section</p>
            </div>
            
            <!-- Mode of Shipment | Trade Type -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-1 mb-1">
                <mat-form-field appearance="outline">
                    <mat-label>Mode of Shipment</mat-label>
                    <mat-select formControlName="modeOfShipment">
                      <mat-option value="1">Sea</mat-option>
                      <mat-option value="2">Air</mat-option>
                    </mat-select>
                </mat-form-field>
                <mat-form-field appearance="outline">
                    <mat-label>Trade Type</mat-label>
                    <input matInput formControlName="tradeType" value="Marine Cargo Import" readonly>
                </mat-form-field>
            </div>
            
            
            <!-- Vessel Name | IDF Number -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-1 mb-1">
                <mat-form-field appearance="outline">
                    <mat-label>Vessel Name</mat-label>
                    <input matInput formControlName="vesselName" placeholder="Enter vessel name">
                </mat-form-field>
                <mat-form-field appearance="outline">
                    <mat-label>IDF Number
                        <mat-icon class="format-info-icon" 
                                  matTooltip="Required format: 2 digits + 5 capital letters + 9 digits&#10;Example: 24VXOIY000002000" 
                                  matTooltipClass="format-tooltip"
                                  matTooltipPosition="above">
                            info
                        </mat-icon>
                    </mat-label>
                    <input matInput formControlName="gcrNumber" placeholder="24VXOIY000002000" maxlength="16" style="text-transform: uppercase;" (input)="onIdfNumberInput($event)">
                    <mat-error *ngIf="shipmentForm.get('gcrNumber')?.hasError('required')">
                        IDF Number is required
                    </mat-error>
                    <mat-error *ngIf="shipmentForm.get('gcrNumber')?.hasError('idfNumber')">
                        Invalid format. Must be: 2 digits + 5 letters + 9 digits
                    </mat-error>
                </mat-form-field>
            </div>
            
            <!-- Sum Insured (Full Width) -->
            <div class="mb-2">
                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Sum Insured (KES)</mat-label>
                    <input matInput type="text" formControlName="sumInsured" appThousands placeholder="3,500,000" inputmode="numeric">
                </mat-form-field>
            </div>
            
            <!-- Packaging Type -->
            <div class="mb-2">
                <label class="block text-sm font-medium text-gray-700 mb-1">Marine Packaging Type</label>
                <mat-radio-group formControlName="commodityType" color="primary">
                  <mat-radio-button value="1" class="mr-4">Containerized</mat-radio-button>
                  <mat-radio-button value="2">Non-Containerized</mat-radio-button>
                </mat-radio-group>
            </div>
            
            <!-- Select Category | Cargo Type -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-1 mb-1">
                <mat-form-field appearance="outline">
                    <mat-label>Select Category</mat-label>
                    <mat-select formControlName="selectCategory" (openedChange)="onDropdownOpen('categories')">
                        <mat-option>
                            <ngx-mat-select-search [formControl]="categorySearchCtrl" placeholderLabel="Search categories..."></ngx-mat-select-search>
                        </mat-option>
                        <mat-option *ngFor="let category of filteredCategories | async" [value]="category.id">
                            {{ category.catname }}
                        </mat-option>
                        <mat-option *ngIf="isLoadingCategories" disabled>
                            <mat-spinner diameter="20"></mat-spinner> Loading...
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <mat-form-field appearance="outline">
                    <mat-label>Cargo Type</mat-label>
                    <mat-select formControlName="salesCategory">
                        <mat-option>
                            <ngx-mat-select-search [formControl]="cargoTypeSearchCtrl" placeholderLabel="Search cargo types..."></ngx-mat-select-search>
                        </mat-option>
                        <mat-option *ngFor="let cargoType of filteredCargoTypes | async" [value]="cargoType.id">
                            {{ cargoType.ctname }}
                        </mat-option>
                        <mat-option *ngIf="isLoadingCargoTypes" disabled>
                            <mat-spinner diameter="20"></mat-spinner> Loading...
                        </mat-option>
                        <mat-option *ngIf="!isLoadingCargoTypes && (filteredCargoTypes | async)?.length === 0" disabled>
                            Please select a category first
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            
            <!-- Date of Dispatch | Estimated Time of Arrival -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-1 mb-1">
                <mat-form-field appearance="outline">
                    <mat-label>Date of Dispatch</mat-label>
                    <input matInput [matDatepicker]="dispatchPicker" formControlName="dateOfDispatch">
                    <mat-datepicker-toggle matSuffix [for]="dispatchPicker"></mat-datepicker-toggle>
                    <mat-datepicker #dispatchPicker></mat-datepicker>
                </mat-form-field>
                <mat-form-field appearance="outline">
                    <mat-label>Date of Arrival</mat-label>
                    <input matInput [matDatepicker]="arrivalPicker" formControlName="estimatedArrival">
                    <mat-datepicker-toggle matSuffix [for]="arrivalPicker"></mat-datepicker-toggle>
                    <mat-datepicker #arrivalPicker></mat-datepicker>
                </mat-form-field>
            </div>
            
            <!-- Country of Origin | Loading Port -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-1 mb-1">
                <mat-form-field appearance="outline">
                    <mat-label>Country of Origin</mat-label>
                    <mat-select formControlName="countryOfOrigin" (openedChange)="onDropdownOpen('countries')">
                        <mat-option>
                            <ngx-mat-select-search [formControl]="countrySearchCtrl" placeholderLabel="Search countries..."></ngx-mat-select-search>
                        </mat-option>
                        <mat-option *ngFor="let country of filteredCountries | async" [value]="country.id">
                            {{ country.countryname }}
                        </mat-option>
                        <mat-option *ngIf="isLoadingCountries" disabled>
                            <mat-spinner diameter="20"></mat-spinner> Loading...
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <mat-form-field appearance="outline">
                    <mat-label>Loading Port</mat-label>
                    <mat-select formControlName="loadingPort" (openedChange)="onDropdownOpen('loadingPorts')" 
                               (scroll)="onLoadingPortScroll()">
                        <mat-option>
                            <ngx-mat-select-search [formControl]="loadingPortSearchCtrl" placeholderLabel="Search loading ports..."></ngx-mat-select-search>
                        </mat-option>
                        <mat-option *ngFor="let port of filteredLoadingPorts | async" [value]="getPortId(port)">
                            {{ getPortDisplayName(port) }}
                        </mat-option>
                        <mat-option *ngIf="isLoadingLoadingPorts" disabled>
                            <mat-spinner diameter="20"></mat-spinner> Loading ports...
                        </mat-option>
                        <mat-option *ngIf="(filteredLoadingPorts | async)?.length === 0 && !isLoadingLoadingPorts" disabled>
                            <em>⚠️ Ports unavailable. Please contact support or try again later.</em>
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            
            <!-- Port of Discharge | Final Destination -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-1 mb-1">
                <mat-form-field appearance="outline">
                    <mat-label>Port of Discharge</mat-label>
                    <mat-select formControlName="portOfDischarge" (openedChange)="onDropdownOpen('dischargePorts')"
                               (scroll)="onDischargePortScroll()">
                        <mat-option>
                            <ngx-mat-select-search [formControl]="dischargePortSearchCtrl" placeholderLabel="Search discharge ports..."></ngx-mat-select-search>
                        </mat-option>
                        <mat-option *ngFor="let port of filteredDischargePorts | async" [value]="getPortId(port)">
                            {{ getPortDisplayName(port) }}
                        </mat-option>
                        <mat-option *ngIf="isLoadingDischargePorts" disabled>
                            <mat-spinner diameter="20"></mat-spinner> Loading ports...
                        </mat-option>
                        <mat-option *ngIf="(filteredDischargePorts | async)?.length === 0 && !isLoadingDischargePorts" disabled>
                            <em>⚠️ Ports unavailable. Please contact support or try again later.</em>
                        </mat-option>
                    </mat-select>
                </mat-form-field>
                <mat-form-field appearance="outline">
                    <mat-label>Final Destination</mat-label>
                    <mat-select formControlName="finalDestination">
                        <mat-option>
                            <ngx-mat-select-search [formControl]="countySearchCtrl" placeholderLabel="Search counties..."></ngx-mat-select-search>
                        </mat-option>
                        <mat-option *ngFor="let county of filteredCounties | async" [value]="county">
                            {{ county }}
                        </mat-option>
                    </mat-select>
                </mat-form-field>
            </div>
            
            <div>
                <mat-form-field appearance="outline" class="w-full">
                    <mat-label>Description of Goods</mat-label>
                    <textarea matInput formControlName="goodsDescription" placeholder="Describe the type of goods, their value, quantity, packaging details" rows="2"></textarea>
                </mat-form-field>
            </div>
          </div>
        </div>
      </div>

      <!-- Payment Summary Section - Order 2 on mobile, Order 2 on desktop -->
      <div class="lg:col-span-5 order-2">
        <div class="bg-white rounded-lg shadow-sm p-2 lg:h-full flex flex-col">
          <h2 class="text-base font-semibold text-gray-900 mb-2 text-center">Payment</h2>
          
          <!-- Cargo Protection Card -->
          <div class="cargo-protection-card mb-3">
            <div class="protection-header">
              <span class="protection-title">Cargo Protection</span>
              <mat-icon class="info-icon">info</mat-icon>
            </div>
            <div class="protection-content">
              <span class="protection-value">{{ getCargoProtectionName() }}</span>
            </div>
          </div>
          
          <div class="space-y-1 mb-2 pb-2 border-b">
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Sum Insured</span>
              <span class="font-medium">KES {{ (shipmentForm.get('sumInsured')?.value || 0) | number:'1.2-2' }}</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Base Premium</span>
              <span class="font-medium">KES {{ premium | number:'1.2-2' }}</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">PHCF (0.25%)</span>
              <span class="font-medium">KES {{ (premium * 0.0025) | number:'1.2-2' }}</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Training Levy (0.2%)</span>
              <span class="font-medium">KES {{ (premium * 0.002) | number:'1.2-2' }}</span>
            </div>
            <div class="flex justify-between text-sm">
              <span class="text-gray-600">Stamp Duty (0.05%)</span>
              <span class="font-medium">KES {{ (premium * 0.0005) | number:'1.2-2' }}</span>
            </div>
          </div>
          <div class="flex justify-between text-base font-semibold mb-4 pb-3 border-b border-gray-200">
            <span>Total Amount</span>
            <span class="text-blue-600">KES {{ total | number:'1.2-2' }}</span>
          </div>
          
          <!-- M-Pesa Number Field -->
          <div class="mb-4 mt-2">
            <mat-form-field appearance="outline" class="w-full">
              <mat-label>M-Pesa Number</mat-label>
              <input matInput formControlName="mpesaNumber" placeholder="07XXXXXXXX" maxlength="10">
            </mat-form-field>
          </div>
          
          <button mat-raised-button color="primary" class="w-full mt-2 pay-now-button" (click)="onSubmit()" [disabled]="isSubmitting">
            <mat-spinner *ngIf="isSubmitting" diameter="24" class="mr-2"></mat-spinner>
            {{ isSubmitting ? 'Processing...' : 'Pay Now' }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>
